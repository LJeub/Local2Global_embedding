<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>local2global_embedding.run.run &mdash; local2global_embedding 1.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=19f00094" />

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../../_static/documentation_options.js?v=f2a433a1"></script>
        <script src="../../../_static/doctools.js?v=888ff710"></script>
        <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            local2global_embedding
          </a>
              <div class="version">
                1.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
    
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../index.html">Home</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Contents</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../reference.html">Reference</a></li>
</ul>

<p class="caption" role="heading"><span class="caption-text">Index</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../genindex.html">Index</a></li>
</ul>
  
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">local2global_embedding</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">local2global_embedding.run.run</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for local2global_embedding.run.run</h1><div class="highlight"><pre>
<span></span><span class="c1">#  Copyright (c) 2021. Lucas G. S. Jeub</span>
<span class="c1">#</span>
<span class="c1">#  Permission is hereby granted, free of charge, to any person obtaining a copy</span>
<span class="c1">#  of this software and associated documentation files (the &quot;Software&quot;), to deal</span>
<span class="c1">#  in the Software without restriction, including without limitation the rights</span>
<span class="c1">#  to use, copy, modify, merge, publish, distribute, sublicense, and/or sell</span>
<span class="c1">#  copies of the Software, and to permit persons to whom the Software is</span>
<span class="c1">#  furnished to do so, subject to the following conditions:</span>
<span class="c1">#</span>
<span class="c1">#  The above copyright notice and this permission notice shall be included in all</span>
<span class="c1">#  copies or substantial portions of the Software.</span>
<span class="c1">#</span>
<span class="c1">#  THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR</span>
<span class="c1">#  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,</span>
<span class="c1">#  FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE</span>
<span class="c1">#  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER</span>
<span class="c1">#  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,</span>
<span class="c1">#  OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE</span>
<span class="c1">#  SOFTWARE.</span>

<span class="sd">&quot;&quot;&quot;Training run script&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">filelock</span> <span class="kn">import</span> <span class="n">SoftFileLock</span><span class="p">,</span> <span class="n">FileLock</span>

<span class="kn">from</span> <span class="nn">local2global_embedding.network</span> <span class="kn">import</span> <span class="n">TGraph</span>
<span class="kn">from</span> <span class="nn">local2global_embedding.run.once_per_worker</span> <span class="kn">import</span> <span class="n">once_per_worker</span>
<span class="kn">from</span> <span class="nn">weakref</span> <span class="kn">import</span> <span class="n">finalize</span>

<span class="kn">from</span> <span class="nn">local2global_embedding.run.once_per_worker.once_per_worker</span> <span class="kn">import</span> <span class="n">OncePerWorker</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;importing build-in modules&#39;</span><span class="p">)</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span>
<span class="kn">from</span> <span class="nn">runpy</span> <span class="kn">import</span> <span class="n">run_path</span>
<span class="kn">from</span> <span class="nn">traceback</span> <span class="kn">import</span> <span class="n">print_exception</span>
<span class="kn">from</span> <span class="nn">collections.abc</span> <span class="kn">import</span> <span class="n">Iterable</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">copy</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;importing numpy&#39;</span><span class="p">)</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;importing pytorch&#39;</span><span class="p">)</span>
<span class="kn">import</span> <span class="nn">torch</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;importing dask&#39;</span><span class="p">)</span>
<span class="kn">import</span> <span class="nn">dask</span>
<span class="kn">import</span> <span class="nn">dask.distributed</span>
<span class="kn">from</span> <span class="nn">dask.distributed</span> <span class="kn">import</span> <span class="n">as_completed</span><span class="p">,</span> <span class="n">Client</span><span class="p">,</span> <span class="n">get_worker</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;importing log and progress modules&#39;</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">import</span> <span class="nn">enlighten</span>
<span class="kn">import</span> <span class="nn">logging</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;importing needed functions&#39;</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">local2global_embedding.run.utils</span> <span class="kn">import</span> <span class="p">(</span><span class="n">ResultsDict</span><span class="p">,</span> <span class="n">load_data</span><span class="p">,</span> <span class="n">ScriptParser</span><span class="p">,</span> <span class="n">patch_folder_name</span><span class="p">,</span>
                                              <span class="n">cluster_file_name</span><span class="p">,</span> <span class="n">watch_progress</span><span class="p">,</span>
                                              <span class="n">load_classification_problem</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">local2global_embedding.utils</span> <span class="kn">import</span> <span class="n">speye</span><span class="p">,</span> <span class="n">set_device</span>
<span class="kn">from</span> <span class="nn">local2global_embedding.run.scripts</span> <span class="kn">import</span> <span class="n">functions</span> <span class="k">as</span> <span class="n">func</span>
<span class="kn">from</span> <span class="nn">local2global_embedding.run.scripts.utils</span> <span class="kn">import</span> <span class="n">build_patch</span><span class="p">,</span> <span class="n">ScopedTemporaryFile</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partialmethod</span>
<span class="kn">from</span> <span class="nn">tempfile</span> <span class="kn">import</span> <span class="n">NamedTemporaryFile</span>


<div class="viewcode-block" id="with_dependencies">
<a class="viewcode-back" href="../../../reference/local2global_embedding.run.run.with_dependencies.html#local2global_embedding.run.run.with_dependencies">[docs]</a>
<span class="k">def</span> <span class="nf">with_dependencies</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">f_d</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">_depends_on</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">f</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="n">f_d</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="vm">__name__</span>
    <span class="k">return</span> <span class="n">f_d</span></div>



<div class="viewcode-block" id="run">
<a class="viewcode-back" href="../../../reference/local2global_embedding.run.run.run.html#local2global_embedding.run.run.run">[docs]</a>
<span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Cora&#39;</span><span class="p">,</span> <span class="n">data_root</span><span class="o">=</span><span class="s1">&#39;/tmp&#39;</span><span class="p">,</span> <span class="n">no_features</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="s1">&#39;VGAE&#39;</span><span class="p">,</span> <span class="n">num_epochs</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span>
        <span class="n">patience</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">runs</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">cl_runs</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">dims</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">hidden_multiplier</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">target_patch_degree</span><span class="o">=</span><span class="mf">4.0</span><span class="p">,</span>
        <span class="n">min_overlap</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">target_overlap</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">gamma</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">sparsify</span><span class="o">=</span><span class="s1">&#39;resistance&#39;</span><span class="p">,</span> <span class="n">train_directed</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">cluster</span><span class="o">=</span><span class="s1">&#39;metis&#39;</span><span class="p">,</span> <span class="n">num_clusters</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">beta</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">num_iters</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">lr</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span> <span class="n">cl_model</span><span class="o">=</span><span class="s1">&#39;logistic&#39;</span><span class="p">,</span>
        <span class="n">cl_train_args</span><span class="o">=</span><span class="p">{},</span> <span class="n">cl_model_args</span><span class="o">=</span><span class="p">{},</span> <span class="n">dist</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">output</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">device</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">verbose_train</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbose_l2g</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">resparsify</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">run_baseline</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">normalise</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">restrict_lcc</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">rotate</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">translate</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">mmap_edges</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">mmap_features</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">random_split</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">use_tmp</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">cluster_init</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">use_gpu_frac</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">grid_search_params</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">progress_bars</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Run training example.</span>

<span class="sd">    By default this function writes results to the current working directory. To override this use the ``output``</span>
<span class="sd">    argument.</span>

<span class="sd">    Args:</span>
<span class="sd">        name: Name of data set to load (one of {``&#39;Cora&#39;``, ``&#39;PubMed&#39;``, ``&#39;AMZ_computers&#39;``, ``&#39;AMZ_photo&#39;``})</span>
<span class="sd">        data_root: Directory to use for downloaded data</span>
<span class="sd">        no_features: If ``True``, discard features and use node identity.</span>
<span class="sd">        model: embedding model type (one of {&#39;VGAE&#39;, &#39;GAE&#39;, &#39;DGI&#39;})</span>
<span class="sd">        num_epochs: Number of training epochs</span>
<span class="sd">        patience: Patience for early stopping</span>
<span class="sd">        runs: Number of training runs (keep best result)</span>
<span class="sd">        dims: list of embedding dimensions (default: ``[2]``)</span>
<span class="sd">        hidden_multiplier: Hidden dimension is ``hidden_multiplier * dim``</span>
<span class="sd">        target_patch_degree: Target patch degree for resistance sparsification.</span>
<span class="sd">        min_overlap: Minimum target patch overlap (default: ``max(dims) + 1``)</span>
<span class="sd">        target_overlap: Target patch overlap (default: ``2 * max(dims)``)</span>
<span class="sd">        gamma: Value of &#39;gamma&#39; for RMST sparsification</span>
<span class="sd">        sparsify: Sparsification method to use (one of {``&#39;resistance&#39;``, ``&#39;none&#39;``, ``&#39;rmst&#39;``})</span>
<span class="sd">        train_directed: Use the orignal directed network (only relevant for some loaders) (default: ``False``)</span>
<span class="sd">        cluster: Clustering method to use (one of {``&#39;louvain&#39;``, ``&#39;fennel&#39;`` , ``&#39;distributed&#39;``, ``&#39;metis&#39;``})</span>
<span class="sd">        num_clusters: Target number of clusters for distributed, fennel, or metis.</span>
<span class="sd">        beta: Parameter for the distributed clustering algorithm</span>
<span class="sd">        num_iters: Maximum iterations for distributed or fennel</span>
<span class="sd">        lr: Learning rate</span>
<span class="sd">        cl_model: the classification model to use (one of &quot;logistic&quot; or &quot;mlp&quot;) (default: &quot;logistic&quot;)</span>
<span class="sd">        cl_train_args: extra arguments to pass down to the classification training (default: {})</span>
<span class="sd">        cl_model_args: extra arguments to pass to the classfication model constructor (default: {})</span>
<span class="sd">        dist: If ``True``, use distance decoder instead of inner product decoder</span>
<span class="sd">        verbose_l2g: Verbose output for the alignment step (default: ``False``)</span>
<span class="sd">        normalise: If True, normalise the dataset features (default: ``False``)</span>
<span class="sd">        restrict_lcc: If True, restrict the dataset to only consider largest connected component (default: ``False``)</span>
<span class="sd">        output: output folder</span>
<span class="sd">        levels: number of hierarchical patch levels (default: 1)</span>
<span class="sd">        resparsify: if &gt; 0, use resistance sparsification for all levels of th hierarchy (default: 0)</span>
<span class="sd">        scale: apply scaling transformations during alignment (default: False)</span>
<span class="sd">        rotate: apply rotations during alignment (default: True)</span>
<span class="sd">        translate: apply translations during alignment (default: True)</span>
<span class="sd">        mmap_edges: use memory mapping for edges (only supported by some loaders) (default: False)</span>
<span class="sd">        mmap_features: use memory mapping for features (only supported by some loaders) (default: False)</span>
<span class="sd">        random_split: use random train-test splits for evaluation (default: True)</span>
<span class="sd">        use_tmp: copy data to tmp dir during load (default: False)</span>
<span class="sd">        cluster_init: run the cluster initialisation script (default: False)</span>
<span class="sd">        use_gpu_frac: fraction of gpu to use by each worker (default: 1.0)</span>
<span class="sd">        grid_search_params: use grid search for classification parameters (only for cl_model=&#39;mlp&#39;)</span>
<span class="sd">        device: Device used for training e.g., &#39;cpu&#39;, &#39;cuda&#39; (defaults to &#39;cuda&#39; if available else &#39;cpu&#39;)</span>
<span class="sd">        verbose_train: If ``True``, show progress info</span>
<span class="sd">        run_baseline: if ``True``, run baseline full model</span>
<span class="sd">        progress_bars: show progress bars (default: True)</span>

<span class="sd">    This function is also exposed as a command-line interface.</span>

<span class="sd">    .. rubric:: References</span>

<span class="sd">    .. [#l2g] L. G. S. Jeub et al.</span>
<span class="sd">              “Local2Global: Scaling global representation learning on graphs via local training”.</span>
<span class="sd">              DLG-KDD’21. 2021. `arXiv:2107.12224 [cs.LG] &lt;https://arxiv.org/abs/2107.12224&gt;`_.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">progress_bars</span><span class="p">:</span>
        <span class="n">tqdm</span><span class="o">.</span><span class="fm">__init__</span> <span class="o">=</span> <span class="n">partialmethod</span><span class="p">(</span><span class="n">tqdm</span><span class="o">.</span><span class="fm">__init__</span><span class="p">,</span> <span class="n">disable</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">grid_search_params</span> <span class="o">=</span> <span class="n">grid_search_params</span> <span class="ow">and</span> <span class="n">cl_model</span> <span class="o">==</span> <span class="s1">&#39;mlp&#39;</span>  <span class="c1"># grid search only implemented for MLP</span>
    <span class="k">if</span> <span class="n">grid_search_params</span><span class="p">:</span>
        <span class="n">eval_func</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="n">mlp_grid_search_eval</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">eval_func</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="n">evaluate</span>

    <span class="k">if</span> <span class="n">verbose_train</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">cluster_init</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;setting up cluster&#39;</span><span class="p">)</span>
        <span class="n">cluster_init_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">()</span><span class="o">.</span><span class="n">home</span><span class="p">()</span> <span class="o">/</span> <span class="s1">&#39;.config&#39;</span> <span class="o">/</span> <span class="s1">&#39;dask&#39;</span> <span class="o">/</span> <span class="s1">&#39;cluster_init.py&#39;</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="n">run_path</span><span class="p">(</span><span class="n">cluster_init_path</span><span class="p">)</span>
        <span class="n">client</span> <span class="o">=</span> <span class="n">Client</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;cluster&#39;</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;launching default client&#39;</span><span class="p">)</span>
        <span class="n">client</span> <span class="o">=</span> <span class="n">Client</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">client</span><span class="o">.</span><span class="n">dashboard_link</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;gpu&#39;</span> <span class="ow">in</span> <span class="n">dask</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;distributed.worker.resources&#39;</span><span class="p">):</span>
        <span class="n">gpu_req</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;gpu&#39;</span><span class="p">:</span> <span class="n">use_gpu_frac</span><span class="p">}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">gpu_req</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">if</span> <span class="n">dims</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">dims</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">output_folder</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">output</span><span class="p">)</span><span class="o">.</span><span class="n">expanduser</span><span class="p">()</span>
    <span class="n">data_root</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">data_root</span><span class="p">)</span><span class="o">.</span><span class="n">expanduser</span><span class="p">()</span>
    <span class="n">result_folder_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">num_epochs</span><span class="si">=}</span><span class="s1">_</span><span class="si">{</span><span class="n">patience</span><span class="si">=}</span><span class="s1">_</span><span class="si">{</span><span class="n">lr</span><span class="si">=}</span><span class="s1">&#39;</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Started experiment for data set </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Results will be placed in </span><span class="si">{</span><span class="n">output_folder</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Data root is </span><span class="si">{</span><span class="n">data_root</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">use_tmp</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Any memmapped data will be moved to local storage.&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">normalise</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;features will be normalised before training&#39;</span><span class="p">)</span>

    <span class="n">manager</span> <span class="o">=</span> <span class="n">enlighten</span><span class="o">.</span><span class="n">get_manager</span><span class="p">(</span><span class="n">threaded</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">baseline_progress</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="n">counter</span><span class="p">(</span><span class="n">desc</span><span class="o">=</span><span class="s1">&#39;baseline&#39;</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>
    <span class="n">patch_progress</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="n">counter</span><span class="p">(</span><span class="n">desc</span><span class="o">=</span><span class="s1">&#39;patch&#39;</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>
    <span class="n">align_progress</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="n">counter</span><span class="p">(</span><span class="n">desc</span><span class="o">=</span><span class="s1">&#39;align&#39;</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>
    <span class="n">eval_progress</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="n">counter</span><span class="p">(</span><span class="n">desc</span><span class="o">=</span><span class="s1">&#39;eval&#39;</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>
    <span class="n">total_progress</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="n">counter</span><span class="p">(</span><span class="n">desc</span><span class="o">=</span><span class="s1">&#39;total&#39;</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">progress_callback</span><span class="p">(</span><span class="n">bar</span><span class="p">):</span>
        <span class="n">bar</span><span class="o">.</span><span class="n">total</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">total_progress</span><span class="o">.</span><span class="n">total</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">def</span> <span class="nf">callback</span><span class="p">(</span><span class="n">future</span><span class="p">):</span>
            <span class="n">bar</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
            <span class="n">total_progress</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">callback</span>

    <span class="k">if</span> <span class="n">train_directed</span><span class="p">:</span>
        <span class="n">train_basename</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">_dir_</span><span class="si">{</span><span class="n">model</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="n">eval_basename</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">_dir_</span><span class="si">{</span><span class="n">model</span><span class="si">}</span><span class="s1">&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">train_basename</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">model</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="n">eval_basename</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">model</span><span class="si">}</span><span class="s1">&#39;</span>

    <span class="n">min_overlap</span> <span class="o">=</span> <span class="n">min_overlap</span> <span class="k">if</span> <span class="n">min_overlap</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">max</span><span class="p">(</span><span class="n">dims</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">target_overlap</span> <span class="o">=</span> <span class="n">target_overlap</span> <span class="k">if</span> <span class="n">target_overlap</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">2</span> <span class="o">*</span> <span class="nb">max</span><span class="p">(</span><span class="n">dims</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">dist</span><span class="p">:</span>
        <span class="n">eval_basename</span> <span class="o">+=</span> <span class="s1">&#39;_dist&#39;</span>
        <span class="k">if</span> <span class="n">model</span> <span class="o">!=</span> <span class="s1">&#39;DGI&#39;</span><span class="p">:</span>
            <span class="n">train_basename</span> <span class="o">+=</span> <span class="s1">&#39;_dist&#39;</span>

    <span class="k">if</span> <span class="n">normalise</span><span class="p">:</span>
        <span class="n">eval_basename</span> <span class="o">+=</span> <span class="s1">&#39;_norm&#39;</span>
        <span class="n">train_basename</span> <span class="o">+=</span> <span class="s1">&#39;_norm&#39;</span>

    <span class="k">if</span> <span class="n">grid_search_params</span><span class="p">:</span>
        <span class="n">eval_basename</span> <span class="o">+=</span> <span class="s1">&#39;_gridsearch&#39;</span>
    <span class="n">eval_basename</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;_</span><span class="si">{</span><span class="n">cl_model</span><span class="si">}</span><span class="s1">&#39;</span>
    <span class="k">if</span> <span class="n">cl_model_args</span><span class="p">:</span>
        <span class="n">eval_basename</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;(</span><span class="si">{</span><span class="n">cl_model_args</span><span class="si">}</span><span class="s1">)&#39;</span>
    <span class="k">if</span> <span class="n">cl_train_args</span><span class="p">:</span>
        <span class="n">eval_basename</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">cl_train_args</span><span class="si">}</span><span class="s1">&#39;</span>

    <span class="n">l2g_name</span> <span class="o">=</span> <span class="s1">&#39;l2g&#39;</span>
    <span class="k">if</span> <span class="n">scale</span><span class="p">:</span>
        <span class="n">l2g_name</span> <span class="o">+=</span> <span class="s1">&#39;_scale&#39;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">rotate</span><span class="p">:</span>
        <span class="n">l2g_name</span> <span class="o">+=</span> <span class="s2">&quot;_norotate&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">translate</span><span class="p">:</span>
        <span class="n">l2g_name</span> <span class="o">+=</span> <span class="s2">&quot;_notranslate&quot;</span>
    <span class="k">if</span> <span class="n">levels</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">l2g_name</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;_hc</span><span class="si">{</span><span class="n">levels</span><span class="si">}</span><span class="s1">&#39;</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lr</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">):</span>
        <span class="n">lr</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">lr</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lr</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">runs</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lr</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">lr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">lr</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">lr</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">runs</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Number of learning rates </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">lr</span><span class="p">)</span><span class="si">}</span><span class="s1"> specified does not match number of runs </span><span class="si">{</span><span class="n">runs</span><span class="si">}</span><span class="s1">.&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">lr</span> <span class="o">=</span> <span class="p">[</span><span class="n">lr</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">runs</span><span class="p">)]</span>

    <span class="n">all_tasks</span> <span class="o">=</span> <span class="n">as_completed</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">build_training_data</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">device</span><span class="p">):</span>
        <span class="n">device</span> <span class="o">=</span> <span class="n">set_device</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">TGraph</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">no_features</span><span class="p">:</span>
            <span class="n">data</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">speye</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">num_nodes</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">data</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">as_tensor</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">normalise</span><span class="p">:</span>
                <span class="n">r_sum</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">r_sum</span><span class="p">[</span><span class="n">r_sum</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>  <span class="c1"># avoid division by zero</span>
                <span class="n">data</span><span class="o">.</span><span class="n">x</span> <span class="o">/=</span> <span class="n">r_sum</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">data</span>

    <span class="nd">@dask</span><span class="o">.</span><span class="n">delayed</span><span class="p">(</span><span class="n">pure</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">traverse</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">load_patch</span><span class="p">(</span><span class="n">patch_folder</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">_get_value</span><span class="p">()</span>
        <span class="n">nodes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">patch_folder</span> <span class="o">/</span> <span class="sa">f</span><span class="s1">&#39;patch</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">_index.npy&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">OncePerWorker</span><span class="o">.</span><span class="n">instance_for_function</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">build_training_data</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">subgraph</span><span class="p">(</span><span class="n">nodes</span><span class="p">,</span> <span class="n">relabel</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span> <span class="n">device</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">load_patch_data</span><span class="p">(</span><span class="n">patch_folder</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">n_patches</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">load_patch</span><span class="p">(</span><span class="n">patch_folder</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_patches</span><span class="p">)]</span>

    <span class="k">def</span> <span class="nf">load_and_copy_data</span><span class="p">():</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">load_data</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="n">data_root</span><span class="p">,</span> <span class="n">restrict_lcc</span><span class="o">=</span><span class="n">restrict_lcc</span><span class="p">,</span>
                         <span class="n">mmap_edges</span><span class="o">=</span><span class="n">mmap_edges</span><span class="p">,</span> <span class="n">mmap_features</span><span class="o">=</span><span class="n">mmap_features</span><span class="p">,</span> <span class="n">directed</span><span class="o">=</span><span class="n">train_directed</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">use_tmp</span><span class="p">:</span>
            <span class="n">tmpdir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;TMPDIR&quot;</span><span class="p">,</span> <span class="s2">&quot;/tmp&quot;</span><span class="p">))</span>
            <span class="n">e_file</span> <span class="o">=</span> <span class="n">tmpdir</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">_edges.npy&quot;</span>
            <span class="n">x_file</span> <span class="o">=</span> <span class="n">tmpdir</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">_x.npy&quot;</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">edge_index</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">memmap</span><span class="p">):</span>
                <span class="k">with</span> <span class="n">FileLock</span><span class="p">(</span><span class="n">tmpdir</span><span class="o">/</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">_edges.lock&quot;</span><span class="p">):</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">e_file</span><span class="p">)</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">e_file</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">edge_index</span><span class="p">)</span>
                    <span class="n">data</span><span class="o">.</span><span class="n">edge_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">e_file</span><span class="p">,</span> <span class="n">mmap_mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">memmap</span><span class="p">):</span>
                <span class="k">with</span> <span class="n">FileLock</span><span class="p">(</span><span class="n">tmpdir</span><span class="o">/</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">_x.lock&quot;</span><span class="p">):</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">x_file</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">x_file</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
                    <span class="n">data</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">x_file</span><span class="p">,</span> <span class="n">mmap_mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>

        <span class="n">cl_data</span> <span class="o">=</span> <span class="n">load_classification_problem</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="n">data_root</span><span class="p">)</span>
        <span class="n">data</span><span class="o">.</span><span class="n">cl_data</span> <span class="o">=</span> <span class="n">cl_data</span>
        <span class="k">return</span> <span class="n">data</span>

    <span class="n">data</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">baseline_train_data</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_load_data</span><span class="p">():</span>
        <span class="k">nonlocal</span> <span class="n">data</span>
        <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">once_per_worker</span><span class="p">(</span><span class="n">load_and_copy_data</span><span class="p">)</span>

    <span class="nd">@dask</span><span class="o">.</span><span class="n">delayed</span><span class="p">(</span><span class="n">pure</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">traverse</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">build_baseline_training_data</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">_get_value</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">OncePerWorker</span><span class="o">.</span><span class="n">instance_for_function</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">build_training_data</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">device</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_baseline_data</span><span class="p">():</span>
        <span class="k">nonlocal</span> <span class="n">baseline_train_data</span>
        <span class="n">_load_data</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">baseline_train_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">baseline_train_data</span> <span class="o">=</span> <span class="n">build_baseline_training_data</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">run_baseline</span><span class="p">:</span>
        <span class="c1"># compute baseline full model if necessary</span>
        <span class="n">result_folder</span> <span class="o">=</span> <span class="n">output_folder</span> <span class="o">/</span> <span class="n">result_folder_name</span>
        <span class="n">result_folder</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">baseline_eval_file</span> <span class="o">=</span> <span class="n">result_folder</span> <span class="o">/</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">eval_basename</span><span class="si">}</span><span class="s1">_full_eval.json&#39;</span>

        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">dims</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">ResultsDict</span><span class="p">(</span><span class="n">baseline_eval_file</span><span class="p">,</span> <span class="n">lock</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="k">as</span> <span class="n">baseline_data</span><span class="p">:</span>
                <span class="n">r_done</span> <span class="o">=</span> <span class="n">baseline_data</span><span class="o">.</span><span class="n">runs</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
            <span class="n">coords</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">r_done</span><span class="p">,</span> <span class="n">runs</span><span class="p">):</span>
                <span class="n">_load_data</span><span class="p">()</span>
                <span class="n">_baseline_data</span><span class="p">()</span>
                <span class="n">baseline_info_file</span> <span class="o">=</span> <span class="n">result_folder</span> <span class="o">/</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">train_basename</span><span class="si">}</span><span class="s1">_d</span><span class="si">{</span><span class="n">d</span><span class="si">}</span><span class="s1">_r</span><span class="si">{</span><span class="n">r</span><span class="si">}</span><span class="s1">_full_info.json&#39;</span>
                <span class="n">coords_task</span> <span class="o">=</span> <span class="n">dask</span><span class="o">.</span><span class="n">delayed</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="n">train</span><span class="p">,</span> <span class="n">pure</span><span class="o">=</span><span class="kc">False</span><span class="p">)(</span>
                    <span class="n">data</span><span class="o">=</span><span class="n">baseline_train_data</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
                    <span class="n">lr</span><span class="o">=</span><span class="n">lr</span><span class="p">[</span><span class="n">r</span><span class="p">],</span> <span class="n">num_epochs</span><span class="o">=</span><span class="n">num_epochs</span><span class="p">,</span>
                    <span class="n">patience</span><span class="o">=</span><span class="n">patience</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose_train</span><span class="p">,</span>
                    <span class="n">results_file</span><span class="o">=</span><span class="n">baseline_info_file</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="n">d</span><span class="p">,</span>
                    <span class="n">hidden_multiplier</span><span class="o">=</span><span class="n">hidden_multiplier</span><span class="p">,</span>
                    <span class="n">dist</span><span class="o">=</span><span class="n">dist</span><span class="p">,</span>
                    <span class="n">save_coords</span><span class="o">=</span><span class="n">mmap_features</span><span class="p">)</span>
                <span class="n">coords</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">coords_task</span><span class="p">)</span>

                <span class="n">eval_task</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="n">dask</span><span class="o">.</span><span class="n">delayed</span><span class="p">(</span><span class="n">eval_func</span><span class="p">,</span> <span class="n">pure</span><span class="o">=</span><span class="kc">False</span><span class="p">)(</span>
                    <span class="n">model</span><span class="o">=</span><span class="n">cl_model</span><span class="p">,</span>
                    <span class="n">graph</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
                    <span class="n">embedding</span><span class="o">=</span><span class="n">coords_task</span><span class="o">.</span><span class="n">coordinates</span><span class="p">,</span>
                    <span class="n">results_file</span><span class="o">=</span><span class="n">baseline_eval_file</span><span class="p">,</span>
                    <span class="n">dist</span><span class="o">=</span><span class="n">dist</span><span class="p">,</span>
                    <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span>
                    <span class="n">train_args</span><span class="o">=</span><span class="n">cl_train_args</span><span class="p">,</span>
                    <span class="n">model_args</span><span class="o">=</span><span class="n">cl_model_args</span><span class="p">,</span>
                    <span class="n">runs</span><span class="o">=</span><span class="n">cl_runs</span><span class="p">,</span>
                    <span class="n">random_split</span><span class="o">=</span><span class="n">random_split</span><span class="p">,</span>
                    <span class="n">mmap_features</span><span class="o">=</span><span class="n">mmap_features</span><span class="p">,</span>
                    <span class="n">use_tmp</span><span class="o">=</span><span class="n">use_tmp</span><span class="p">),</span> <span class="n">resources</span><span class="o">=</span><span class="n">gpu_req</span><span class="p">)</span>
                <span class="n">eval_task</span><span class="o">.</span><span class="n">add_done_callback</span><span class="p">(</span><span class="n">progress_callback</span><span class="p">(</span><span class="n">baseline_progress</span><span class="p">))</span>
                <span class="n">all_tasks</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">eval_task</span><span class="p">)</span>
                <span class="k">del</span> <span class="n">eval_task</span>
                <span class="k">del</span> <span class="n">coords_task</span>


    <span class="n">patch_folder</span> <span class="o">=</span> <span class="n">output_folder</span> <span class="o">/</span> <span class="n">patch_folder_name</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">min_overlap</span><span class="p">,</span> <span class="n">target_overlap</span><span class="p">,</span> <span class="n">cluster</span><span class="p">,</span> <span class="n">num_clusters</span><span class="p">,</span>
                                                     <span class="n">num_iters</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">levels</span><span class="p">,</span> <span class="n">sparsify</span><span class="p">,</span> <span class="n">target_patch_degree</span><span class="p">,</span>
                                                     <span class="n">gamma</span><span class="p">)</span>
    <span class="n">cluster_file</span> <span class="o">=</span> <span class="n">output_folder</span> <span class="o">/</span> <span class="n">cluster_file_name</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">cluster</span><span class="p">,</span> <span class="n">num_clusters</span><span class="p">,</span> <span class="n">num_iters</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">levels</span><span class="p">)</span>
    <span class="n">result_folder</span> <span class="o">=</span> <span class="n">patch_folder</span> <span class="o">/</span> <span class="n">result_folder_name</span>
    <span class="n">result_folder</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">SoftFileLock</span><span class="p">(</span><span class="n">patch_folder</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s1">&#39;.lock&#39;</span><span class="p">)):</span>
        <span class="n">pg_exists</span> <span class="o">=</span> <span class="p">(</span><span class="n">patch_folder</span> <span class="o">/</span> <span class="s1">&#39;patch_graph.pt&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">is_file</span><span class="p">()</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">pg_exists</span><span class="p">:</span>
        <span class="n">_load_data</span><span class="p">()</span>
        <span class="n">patch_graph</span> <span class="o">=</span> <span class="n">dask</span><span class="o">.</span><span class="n">delayed</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="n">prepare_patches</span><span class="p">,</span> <span class="n">pure</span><span class="o">=</span><span class="kc">False</span><span class="p">)(</span>
            <span class="n">output_folder</span><span class="o">=</span><span class="n">output_folder</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">graph</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
            <span class="n">min_overlap</span><span class="o">=</span><span class="n">min_overlap</span><span class="p">,</span> <span class="n">target_overlap</span><span class="o">=</span><span class="n">target_overlap</span><span class="p">,</span>
            <span class="n">cluster</span><span class="o">=</span><span class="n">cluster</span><span class="p">,</span>
            <span class="n">num_clusters</span><span class="o">=</span><span class="n">num_clusters</span><span class="p">,</span> <span class="n">num_iters</span><span class="o">=</span><span class="n">num_iters</span><span class="p">,</span> <span class="n">beta</span><span class="o">=</span><span class="n">beta</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="n">levels</span><span class="p">,</span>
            <span class="n">sparsify</span><span class="o">=</span><span class="n">sparsify</span><span class="p">,</span> <span class="n">target_patch_degree</span><span class="o">=</span><span class="n">target_patch_degree</span><span class="p">,</span>
            <span class="n">gamma</span><span class="o">=</span><span class="n">gamma</span><span class="p">,</span>
            <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">persist</span><span class="p">()</span>
        <span class="n">patch_graph_initialised</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">num_patches</span> <span class="o">=</span> <span class="n">patch_graph</span><span class="o">.</span><span class="n">num_nodes</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">num_patches</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">patch_folder</span> <span class="o">/</span> <span class="s1">&#39;patch_graph.pt&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">num_nodes</span>
        <span class="n">patch_graph</span> <span class="o">=</span> <span class="n">dask</span><span class="o">.</span><span class="n">delayed</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">,</span> <span class="n">pure</span><span class="o">=</span><span class="kc">True</span><span class="p">)(</span><span class="n">patch_folder</span> <span class="o">/</span> <span class="s1">&#39;patch_graph.pt&#39;</span><span class="p">)</span>
        <span class="n">patch_graph_initialised</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="n">l2g_eval_file</span> <span class="o">=</span> <span class="n">result_folder</span> <span class="o">/</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">eval_basename</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">l2g_name</span><span class="si">}</span><span class="s1">_eval.json&#39;</span>
    <span class="n">n_nodes</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">patch_data</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">dims</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">ResultsDict</span><span class="p">(</span><span class="n">l2g_eval_file</span><span class="p">,</span> <span class="n">lock</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="k">as</span> <span class="n">res</span><span class="p">:</span>
            <span class="n">r_done</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">runs</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
        <span class="n">patch_runs</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_patches</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">r_done</span><span class="p">,</span> <span class="n">runs</span><span class="p">):</span>
            <span class="n">_load_data</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">patch_graph_initialised</span><span class="p">:</span>
                <span class="n">patch_graph</span> <span class="o">=</span> <span class="n">patch_graph</span><span class="o">.</span><span class="n">persist</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">patch_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">patch_data</span> <span class="o">=</span> <span class="n">load_patch_data</span><span class="p">(</span><span class="n">patch_folder</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">num_patches</span><span class="p">)</span>

            <span class="n">patches</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">pi</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_patches</span><span class="p">):</span>
                <span class="n">patch_node_file</span> <span class="o">=</span> <span class="n">patch_folder</span> <span class="o">/</span> <span class="sa">f</span><span class="s1">&#39;patch</span><span class="si">{</span><span class="n">pi</span><span class="si">}</span><span class="s1">_index.npy&#39;</span>
                <span class="n">patch_result_file</span> <span class="o">=</span> <span class="n">result_folder</span> <span class="o">/</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">train_basename</span><span class="si">}</span><span class="s1">_patch</span><span class="si">{</span><span class="n">pi</span><span class="si">}</span><span class="s1">_d</span><span class="si">{</span><span class="n">d</span><span class="si">}</span><span class="s1">_r</span><span class="si">{</span><span class="n">r</span><span class="si">}</span><span class="s1">_info.json&#39;</span>

                <span class="n">patch</span> <span class="o">=</span> <span class="n">dask</span><span class="o">.</span><span class="n">delayed</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="n">train</span><span class="p">,</span> <span class="n">nout</span><span class="o">=</span><span class="mi">2</span><span class="p">)(</span><span class="n">data</span><span class="o">=</span><span class="n">patch_data</span><span class="p">[</span><span class="n">pi</span><span class="p">],</span> <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
                                                  <span class="n">lr</span><span class="o">=</span><span class="n">lr</span><span class="p">[</span><span class="n">r</span><span class="p">],</span> <span class="n">num_epochs</span><span class="o">=</span><span class="n">num_epochs</span><span class="p">,</span>
                                                  <span class="n">patience</span><span class="o">=</span><span class="n">patience</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose_train</span><span class="p">,</span>
                                                  <span class="n">results_file</span><span class="o">=</span><span class="n">patch_result_file</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="n">d</span><span class="p">,</span>
                                                  <span class="n">hidden_multiplier</span><span class="o">=</span><span class="n">hidden_multiplier</span><span class="p">,</span> <span class="n">dist</span><span class="o">=</span><span class="n">dist</span><span class="p">,</span>
                                                  <span class="n">save_coords</span><span class="o">=</span><span class="n">mmap_features</span><span class="p">)</span>
                <span class="n">patches</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">patch</span><span class="p">)</span>
                <span class="k">del</span> <span class="n">patch</span>

            <span class="n">l2g_coords_file</span> <span class="o">=</span> <span class="n">result_folder</span> <span class="o">/</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">train_basename</span><span class="si">}</span><span class="s1">_d</span><span class="si">{</span><span class="n">d</span><span class="si">}</span><span class="s1">_r</span><span class="si">{</span><span class="n">r</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">l2g_name</span><span class="si">}</span><span class="s1">_coords.npy&#39;</span>
            <span class="k">if</span> <span class="n">l2g_coords_file</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">mmap_features</span><span class="p">:</span>
                    <span class="n">l2g_coords</span> <span class="o">=</span> <span class="n">l2g_coords_file</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">l2g_coords</span> <span class="o">=</span> <span class="n">dask</span><span class="o">.</span><span class="n">delayed</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">)(</span><span class="n">file</span><span class="o">=</span><span class="n">l2g_coords_file</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">n_nodes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">n_nodes</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">num_nodes</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
                <span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">n_nodes</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>

                <span class="n">l2g_coords</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="n">hierarchical_l2g_align_patches</span><span class="p">(</span>
                                         <span class="n">patch_graph</span><span class="o">=</span><span class="n">patch_graph</span><span class="p">,</span>
                                         <span class="n">shape</span><span class="o">=</span><span class="n">shape</span><span class="p">,</span>
                                         <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">,</span>
                                         <span class="n">rotate</span><span class="o">=</span><span class="n">rotate</span><span class="p">,</span>
                                         <span class="n">translate</span><span class="o">=</span><span class="n">translate</span><span class="p">,</span>
                                         <span class="n">patches</span><span class="o">=</span><span class="n">patches</span><span class="p">,</span>
                                         <span class="n">mmap</span><span class="o">=</span><span class="n">mmap_features</span><span class="p">,</span>
                                         <span class="n">use_tmp</span><span class="o">=</span><span class="n">use_tmp</span><span class="p">,</span>
                                         <span class="n">verbose</span><span class="o">=</span><span class="n">verbose_l2g</span><span class="p">,</span>
                                         <span class="n">output_file</span><span class="o">=</span><span class="n">l2g_coords_file</span><span class="p">,</span>
                                         <span class="n">cluster_file</span><span class="o">=</span><span class="n">cluster_file</span><span class="p">,</span>
                                         <span class="n">resparsify</span><span class="o">=</span><span class="n">resparsify</span>
                                        <span class="p">)</span>

            <span class="n">coords_task</span> <span class="o">=</span> <span class="n">dask</span><span class="o">.</span><span class="n">delayed</span><span class="p">(</span><span class="n">eval_func</span><span class="p">,</span> <span class="n">pure</span><span class="o">=</span><span class="kc">False</span><span class="p">)(</span>
                <span class="n">model</span><span class="o">=</span><span class="n">cl_model</span><span class="p">,</span>
                <span class="n">graph</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
                <span class="n">embedding</span><span class="o">=</span><span class="n">l2g_coords</span><span class="p">,</span>
                <span class="n">results_file</span><span class="o">=</span><span class="n">l2g_eval_file</span><span class="p">,</span>
                <span class="n">dist</span><span class="o">=</span><span class="n">dist</span><span class="p">,</span>
                <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span>
                <span class="n">train_args</span><span class="o">=</span><span class="n">cl_train_args</span><span class="p">,</span>
                <span class="n">model_args</span><span class="o">=</span><span class="n">cl_model_args</span><span class="p">,</span>
                <span class="n">runs</span><span class="o">=</span><span class="n">cl_runs</span><span class="p">,</span>
                <span class="n">random_split</span><span class="o">=</span><span class="n">random_split</span><span class="p">,</span>
                <span class="n">mmap_features</span><span class="o">=</span><span class="n">mmap_features</span><span class="p">,</span>
                <span class="n">use_tmp</span><span class="o">=</span><span class="n">use_tmp</span>
            <span class="p">)</span>
            <span class="n">coords_task</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="n">coords_task</span><span class="p">,</span> <span class="n">resources</span><span class="o">=</span><span class="n">gpu_req</span><span class="p">)</span>
            <span class="n">coords_task</span><span class="o">.</span><span class="n">add_done_callback</span><span class="p">(</span><span class="n">progress_callback</span><span class="p">(</span><span class="n">eval_progress</span><span class="p">))</span>
            <span class="n">all_tasks</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">coords_task</span><span class="p">)</span>
            <span class="k">del</span> <span class="n">coords_task</span>
            <span class="k">del</span> <span class="n">l2g_coords</span>



    <span class="n">baseline_progress</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>
    <span class="n">patch_progress</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>
    <span class="n">align_progress</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>
    <span class="n">eval_progress</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>
    <span class="n">total_progress</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>

    <span class="c1"># make sure to wait for all tasks to complete and report overall progress</span>
    <span class="n">watch_progress</span><span class="p">(</span><span class="n">all_tasks</span><span class="p">)</span>
    <span class="n">manager</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span></div>



<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;launching main training script&#39;</span><span class="p">)</span>
    <span class="c1"># run main script</span>
    <span class="n">ScriptParser</span><span class="p">(</span><span class="n">run</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, Lucas G. S. Jeub.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>